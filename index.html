<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chatran ðŸ¤–</title>
<style>
body { font-family: Tahoma, sans-serif; background:#f0f0f0; margin:0; padding:0; display:flex; justify-content:center; align-items:center; height:100vh; }
#chat-container { width: 500px; background:#fff; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.2); display:flex; flex-direction:column; }
#messages { flex:1; padding:10px; overflow-y:auto; height:400px; }
.message { margin:5px 0; }
.user { text-align:right; color:#333; }
.bot { text-align:left; color:#0066cc; }
#input-container { display:flex; }
#user-input { flex:1; padding:10px; border:none; border-top:1px solid #ccc; border-radius:0 0 0 10px; }
#send-btn { padding:10px; border:none; background:#0066cc; color:#fff; cursor:pointer; border-radius:0 0 10px 0; }
</style>
</head>
<body>
<div id="chat-container">
  <div id="messages"></div>
  <div id="input-container">
    <input type="text" id="user-input" placeholder="Ù¾ÛŒØ§Ù…ØªÙˆ Ø¨Ù†ÙˆÛŒØ³...">
    <button id="send-btn">Ø§Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script>
// --- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ JSON Ù‡Ø§ ---
let chatData = {};
const files = ['data1.json','data2.json','data3.json','data4.json','data5.json'];
files.forEach(file => {
  fetch(file).then(r=>r.json()).then(json => { chatData = {...chatData,...json}; });
});

// --- ØªØ§Ø±ÛŒØ®Ú†Ù‡ ---
let chatHistory = [];
const saveHistory = () => localStorage.setItem('chatran_history', JSON.stringify(chatHistory));
if(localStorage.getItem('chatran_history')){
  chatHistory = JSON.parse(localStorage.getItem('chatran_history'));
  chatHistory.forEach(msg=>addMessage(msg.user,msg.text));
}

// --- Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… ---
function addMessage(user,text){
  const div = document.createElement('div');
  div.className = 'message ' + (user==='user'?'user':'bot');
  div.innerText = text;
  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}

// --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
function normalizeText(text){
  return text.replace(/[^Ø¢-ÛŒ0-9a-zA-Z ]/g,'').trim().toLowerCase();
}

function similarity(a,b){
  let count=0;
  for(let i=0;i<Math.min(a.length,b.length);i++){ if(a[i]===b[i]) count++; }
  return count/Math.max(a.length,b.length);
}

// --- Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ø³ÛŒØ± ---
function findBestPath(input){
  const inputNorm = normalizeText(input);
  let bestScore = 0;
  let bestKey = '';
  for(let key in chatData){
    const keyNorm = normalizeText(key);
    const score = similarity(inputNorm,keyNorm);
    if(score > bestScore){
      bestScore = score;
      bestKey = key;
    }
  }
  if(bestScore > 0.3) return bestKey;
  return null;
}

// --- Ø³Ø§Ø®Øª Ø¬Ù…Ù„Ù‡ ÙØ§Ø±Ø³ÛŒ Ø¯Ø±Ø³Øª ---
function generateSentence(key){
  if(!key){
    // Ø§Ú¯Ø± Ù…Ø³ÛŒØ± Ù…Ø´Ø§Ø¨Ù‡ Ù†Ø¨ÙˆØ¯ØŒ Ø¬Ù…Ù„Ù‡ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ù¾Ø±Ú©Ø§Ø±Ø¨Ø±Ø¯ØªØ±ÛŒÙ† Ù…Ø³ÛŒØ± Ø¨Ø³Ø§Ø²
    const keys = Object.keys(chatData);
    if(keys.length>0) key = keys[0];
    else return "Chatran: Ø³Ù„Ø§Ù…! Ú†Ù‚Ø¯Ø± Ø®ÙˆØ¨Ù‡ Ú©Ù‡ Ø¨Ø§Ù‡Ø§Øª ØµØ­Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†Ù…. âœ…";
  }
  const parts = key.split(' ');
  const sentence = parts.map(p=>p.charAt(0).toUpperCase()+p.slice(1)).join(' ') + ' âœ…';
  return `Chatran: ${sentence}`;
}

// --- Ù…ÙˆØªÙˆØ± Ø¬Ù…Ù„Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù‡Ø± Ø«Ø§Ù†ÛŒÙ‡ ---
function autoGenerate(){
  const sentence = generateSentence(null);
  addMessage('bot',sentence);
  chatHistory.push({user:'bot',text:sentence});
  saveHistory();
}
setInterval(autoGenerate,1000);

// --- Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ---
function handleUser(input){
  addMessage('user',input);
  const pathKey = findBestPath(input);
  const reply = generateSentence(pathKey);
  addMessage('bot',reply);
  chatHistory.push({user:'user',text:input});
  chatHistory.push({user:'bot',text:reply});
  saveHistory();
}

// --- Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ø±Ø³Ø§Ù„ ---
document.getElementById('send-btn').addEventListener('click',()=>{
  const input = document.getElementById('user-input').value;
  if(!input) return;
  handleUser(input);
  document.getElementById('user-input').value='';
});
</script>
</body>
</html>
