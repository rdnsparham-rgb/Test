<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chatran ğŸ¤–</title>
<style>
body { font-family: Tahoma, sans-serif; background:#f0f0f0; margin:0; padding:0; display:flex; justify-content:center; align-items:center; height:100vh; }
#chat-container { width: 450px; background:#fff; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.2); display:flex; flex-direction:column; }
#messages { flex:1; padding:10px; overflow-y:auto; }
.message { margin:5px 0; }
.user { text-align:right; color:#333; }
.bot { text-align:left; color:#0066cc; }
#input-container { display:flex; }
#user-input { flex:1; padding:10px; border:none; border-top:1px solid #ccc; border-radius:0 0 0 10px; }
#send-btn { padding:10px; border:none; background:#0066cc; color:#fff; cursor:pointer; border-radius:0 0 10px 0; }
</style>
</head>
<body>
<div id="chat-container">
  <div id="messages"></div>
  <div id="input-container">
    <input type="text" id="user-input" placeholder="Ù¾ÛŒØ§Ù…ØªÙˆ Ø¨Ù†ÙˆÛŒØ³...">
    <button id="send-btn">Ø§Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script>
// --- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ JSON ---
let chatData = {};
const files = ['data1.json','data2.json','data3.json','data4.json','data5.json'];

files.forEach(file => {
  fetch(file).then(r=>r.json()).then(json=>{
    chatData = {...chatData, ...json};
  });
});

// --- Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ---
let chatHistory = [];
const saveHistory = () => localStorage.setItem('chatran_history', JSON.stringify(chatHistory));
if(localStorage.getItem('chatran_history')){
  chatHistory = JSON.parse(localStorage.getItem('chatran_history'));
  chatHistory.forEach(msg=>addMessage(msg.user,msg.text));
}

// --- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØµÙØ­Ù‡ ---
function addMessage(user,text){
  const div = document.createElement('div');
  div.className = 'message ' + (user==='user'?'user':'bot');
  div.innerText = text;
  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}

// --- ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­ ØªØ§ÛŒÙ¾ÛŒ Ø³Ø§Ø¯Ù‡ ---
function normalizeText(text){
  return text.replace(/[^Ø¢-ÛŒa-zA-Z0-9 ]/g,'').trim().toLowerCase();
}

// --- ØªØ§Ø¨Ø¹ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ù‡ØªØ±ÛŒÙ† Ø¬ÙˆØ§Ø¨ ---
function findBestReply(input){
  input = normalizeText(input);

  // 1. Ø§Ú¯Ø± Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø³ÛŒØ± Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
  for(let key in chatData){
    if(normalizeText(key) === input) return chatData[key];
  }

  // 2. Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´Ø§Ø¨Ù‡Øª Ø³Ø§Ø¯Ù‡
  let bestMatch = '';
  let maxScore = 0;
  for(let key in chatData){
    let keyNorm = normalizeText(key);
    let score = similarity(input,keyNorm);
    if(score > maxScore){
      maxScore = score;
      bestMatch = chatData[key];
    }
  }
  if(maxScore > 0.3) return bestMatch; // Ø§Ú¯Ø± Ù…Ø´Ø§Ø¨Ù‡ Ø¨ÙˆØ¯

  // 3. Ø³Ø§Ø®Øª Ø¬Ù…Ù„Ù‡ Ø³Ø§Ø¯Ù‡ Ø§Ú¯Ø± Ù‡ÛŒÚ† Ù…Ø³ÛŒØ± Ù…Ø´Ø§Ø¨Ù‡ÛŒ Ù†Ø¨ÙˆØ¯
  return generateSentence(input);
}

// --- ØªØ§Ø¨Ø¹ Ù…Ø´Ø§Ø¨Ù‡Øª Ø³Ø§Ø¯Ù‡ (ØªØ¹Ø¯Ø§Ø¯ Ø­Ø±ÙˆÙ Ù…Ø´ØªØ±Ú©) ---
function similarity(a,b){
  let count=0;
  for(let i=0;i<Math.min(a.length,b.length);i++){
    if(a[i]===b[i]) count++;
  }
  return count/Math.max(a.length,b.length);
}

// --- Ø³Ø§Ø®Øª Ø¬Ù…Ù„Ù‡ ÙØ§Ø±Ø³ÛŒ Ø³Ø§Ø¯Ù‡ ---
function generateSentence(text){
  text = text.split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
  return `chatran: ${text} ... Ù…Ù† Ø¨Ù‡ØªØ±ÛŒÙ† Ø¬ÙˆØ§Ø¨ Ù…Ù…Ú©Ù† Ø±Ø§ Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù….`;
}

// --- Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ø±Ø³Ø§Ù„ ---
document.getElementById('send-btn').addEventListener('click',()=>{
  let input = document.getElementById('user-input').value;
  if(!input) return;
  addMessage('user',input);
  let reply = findBestReply(input);
  addMessage('bot',reply);
  chatHistory.push({user:'user',text:input});
  chatHistory.push({user:'bot',text:reply});
  saveHistory();
  document.getElementById('user-input').value='';
});
</script>
</body>
</html>
